<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academix Authentication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .response {
            background-color: #f8f9fa;
            padding: 10px;
            border-left: 4px solid #007bff;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        h2 {
            color: #343a40;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Academix Authentication System Test</h1>

    <!-- Registration -->
    <div class="container">
        <h2>1. User Registration</h2>
        <div class="form-group">
            <label for="regFirstName">First Name:</label>
            <input type="text" id="regFirstName" value="John">
        </div>
        <div class="form-group">
            <label for="regLastName">Last Name:</label>
            <input type="text" id="regLastName" value="Doe">
        </div>
        <div class="form-group">
            <label for="regEmail">Email:</label>
            <input type="email" id="regEmail" value="john.doe@example.com">
        </div>
        <div style="background-color: #e8f4fd; padding: 10px; border: 1px solid #17a2b8; margin-bottom: 15px;">
            <p><strong>üîê Password:</strong> Will be auto-generated and sent via email</p>
        </div>
        <div class="form-group">
            <label for="regRole">Role:</label>
            <input type="text" id="regRole" value="STUDENT">
        </div>
        <div class="form-group">
            <label for="regGender">Gender:</label>
            <input type="text" id="regGender" value="MALE">
        </div>
        <button onclick="register()">Register</button>
        <div id="regResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Email Verification -->
    <div class="container">
        <h2>2. Email Verification</h2>
        <div class="form-group">
            <label for="verifyToken">Verification Token:</label>
            <input type="text" id="verifyToken" placeholder="Enter verification token from email">
        </div>
        <button onclick="verifyEmail()">Verify Email</button>
        <button onclick="autoFillVerificationToken()" style="background-color: #17a2b8;">Auto-Fill Token</button>
        <button onclick="debugEmailTokens()" style="background-color: #6f42c1; color: white;">üîç Debug User Tokens</button>
        <div id="verifyResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Login -->
    <div class="container">
        <h2>3. User Login</h2>
        <div style="background-color: #e8f5e8; padding: 15px; border: 2px solid #4CAF50; margin-bottom: 15px;">
            <h3 style="color: #2e7d32; margin-top: 0;">‚úÖ Universal Login System</h3>
            <p><strong>üéì Students:</strong> Use your registered email and password</p>
            <p><strong>üë®‚Äçüè´ Teachers/Staff:</strong> Use your account credentials</p>
            <p><strong>üë§ Admins:</strong> Use your admin credentials</p>
            <p><em>üìÇ System automatically detects your user type and redirects to appropriate dashboard!</em></p>
        </div>
        <div style="background-color: #fff3cd; padding: 12px; border: 2px solid #ffc107; margin-bottom: 15px;">
            <h4 style="color: #856404; margin-top: 0;">üîê Email Verification Required!</h4>
            <p><strong>‚ö†Ô∏è Important:</strong> You must verify your email before you can login, even if you have the correct password.</p>
            <p><strong>üìß Steps:</strong> 1) Register ‚Üí 2) Check your email ‚Üí 3) Click verification link ‚Üí 4) Then login</p>
        </div>
        <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        <button onclick="login()" style="background-color: #007bff; font-size: 16px; padding: 12px 24px;">üöÄ Login</button>
        <div id="loginResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Forgot Password -->
    <div class="container">
        <h2>4. Forgot Password</h2>
        <div class="form-group">
            <label for="forgotEmail">Email:</label>
            <input type="email" id="forgotEmail" value="john.doe@example.com">
        </div>
        <button onclick="forgotPassword()">Send Reset Link</button>
        <div id="forgotResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Reset Password -->
    <div class="container">
        <h2>5. Reset Password</h2>
        <div class="form-group">
            <label for="resetToken">Reset Token:</label>
            <input type="text" id="resetToken" placeholder="Enter reset token from email">
        </div>
        <div class="form-group">
            <label for="newPassword">New Password:</label>
            <input type="password" id="newPassword" value="NewSecurePass123">
        </div>
        <button onclick="resetPassword()">Reset Password</button>
        <div id="resetResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Resend Token -->
    <div class="container">
        <h2>6. Resend Token</h2>
        <div class="form-group">
            <label for="resendEmail">Email:</label>
            <input type="email" id="resendEmail" value="john.doe@example.com">
        </div>
        <div class="form-group">
            <label for="tokenType">Token Type:</label>
            <select id="tokenType">
                <option value="verification">Email Verification</option>
                <option value="reset">Password Reset</option>
            </select>
        </div>
        <button onclick="resendToken()">Resend Token</button>
        <div id="resendResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Get All Users -->
    <div class="container">
        <h2>7. Get All Users (Testing Only)</h2>
        <button onclick="getAllUsers()">Get All Users</button>
        <div id="usersResponse" class="response" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'https://organic-winner-pqprvg9gx94f69j7-8080.app.github.dev/api/auth';

        async function makeRequest(url, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);
                const data = await response.json();
                
                return {
                    success: response.ok,
                    data: data,
                    status: response.status
                };
            } catch (error) {
                return {
                    success: false,
                    data: { message: error.message },
                    status: 0
                };
            }
        }

        function showResponse(elementId, result) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'response ' + (result.success ? 'success' : 'error');
            element.textContent = JSON.stringify(result, null, 2);
        }

        async function register() {
            const body = {
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                email: document.getElementById('regEmail').value,
                role: document.getElementById('regRole').value,
                gender: document.getElementById('regGender').value
            };
            
            const result = await makeRequest(`${API_BASE}/register`, 'POST', body);
            showResponse('regResponse', result);
        }

        async function verifyEmail() {
            const body = {
                token: document.getElementById('verifyToken').value
            };
            
            const result = await makeRequest(`${API_BASE}/verify-email`, 'POST', body);
            showResponse('verifyResponse', result);
        }

        async function login() {
            const body = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            
            // Use standard login endpoint (now supports all user types)
            const result = await makeRequest(`${API_BASE}/login`, 'POST', body);
            
            // Enhanced response display with better error handling
            if (result.success && result.data.user) {
                const user = result.data.user;
                const userType = user.role || 'USER';
                const dashboardUrl = getDashboardUrl(userType);
                
                // Create enhanced success message
                const successMessage = {
                    ...result,
                    dashboardRedirect: dashboardUrl,
                    userInfo: {
                        name: user.fullName,
                        email: user.email,
                        role: userType,
                        studentId: user.studentId || null,
                        currentClass: user.currentClass || null,
                        emailVerified: user.emailVerified
                    }
                };
                showResponse('loginResponse', successMessage);
                
                // Store tokens
                if (result.data.accessToken) {
                    localStorage.setItem('accessToken', result.data.accessToken);
                    localStorage.setItem('refreshToken', result.data.refreshToken);
                    localStorage.setItem('userRole', userType);
                    localStorage.setItem('userInfo', JSON.stringify(user));
                }
                
                // Simulate dashboard redirect (in real app, this would redirect)
                setTimeout(() => {
                    if (confirm(`Login successful! Would you like to simulate redirect to ${dashboardUrl}?`)) {
                        alert(`üéâ Redirecting to ${userType} Dashboard: ${dashboardUrl}`);
                    }
                }, 1000);
                
            } else {
                // Handle specific error messages
                const errorMessage = result.data?.message || 'Login failed';
                
                if (errorMessage.includes('verify your email')) {
                    // Email verification error - provide helpful instructions
                    const enhancedError = {
                        ...result,
                        errorType: 'EMAIL_VERIFICATION_REQUIRED',
                        data: {
                            ...result.data,
                            message: errorMessage,
                            instructions: [
                                '1. Check your email inbox for the verification link',
                                '2. Click the link to verify your email address',
                                '3. Return here and try logging in again',
                                '4. If you cannot find the email, use "Resend Token" section below'
                            ],
                            resendInstructions: 'Use section 6 below to resend verification email if needed'
                        }
                    };
                    showResponse('loginResponse', enhancedError);
                    
                    // Auto-fill resend email field
                    try {
                        document.getElementById('resendEmail').value = body.email;
                        document.getElementById('tokenType').value = 'verification';
                    } catch(e) { /* Ignore if elements don't exist */ }
                    
                } else {
                    showResponse('loginResponse', result);
                }
            }
        }

        // Helper function to determine dashboard URL based on user role
        function getDashboardUrl(userType) {
            switch(userType.toUpperCase()) {
                case 'STUDENT':
                    return '/student/dashboard';
                case 'TEACHER': 
                case 'STAFF':
                    return '/staff/dashboard';
                case 'ADMIN':
                    return '/admin/dashboard';
                default:
                    return '/dashboard';
            }
        }

        async function forgotPassword() {
            const body = {
                email: document.getElementById('forgotEmail').value
            };
            
            const result = await makeRequest(`${API_BASE}/forgot-password`, 'POST', body);
            showResponse('forgotResponse', result);
        }

        async function resetPassword() {
            const body = {
                token: document.getElementById('resetToken').value,
                newPassword: document.getElementById('newPassword').value
            };
            
            const result = await makeRequest(`${API_BASE}/reset-password`, 'POST', body);
            showResponse('resetResponse', result);
        }

        async function resendToken() {
            const body = {
                email: document.getElementById('resendEmail').value,
                tokenType: document.getElementById('tokenType').value
            };
            
            const result = await makeRequest(`${API_BASE}/resend-token`, 'POST', body);
            showResponse('resendResponse', result);
        }

        async function getAllUsers() {
            const result = await makeRequest(`${API_BASE}/users`, 'GET');
            showResponse('usersResponse', result);
        }

        // Auto-fill verification token for current registration email
        function autoFillVerificationToken() {
            const email = document.getElementById('regEmail').value;
            if (!email) {
                alert('Please enter an email address first.');
                return;
            }
            getVerificationToken(email);
        }

        // Debug function for the button
        async function debugEmailTokens() {
            const email = document.getElementById('verifyToken').value ? 
                document.getElementById('regEmail').value : 
                prompt('Enter email address to debug:');
                
            if (!email) {
                alert('Please enter an email address.');
                return;
            }
            
            const result = await debugUserTokens(email);
            if (result) {
                const info = `
üîç Debug Info for: ${email}
üìß Email Verified: ${result.emailVerified ? 'Yes ‚úÖ' : 'No ‚ùå'}
üë§ User Type: ${result.userType || 'USER'}
üÜî Role: ${result.role || 'Unknown'}
üîë Has Token: ${result.emailVerificationToken ? 'Yes ‚úÖ' : 'No ‚ùå'}
‚è∞ Token Expires: ${result.emailVerificationExpiry ? new Date(result.emailVerificationExpiry).toLocaleString() : 'Not set'}
üìÖ Created: ${result.createdAt ? new Date(result.createdAt).toLocaleString() : 'Unknown'}
                `.trim();
                
                alert(info);
            }
        }

        // Enhanced debug function to check both user types
        async function debugUserTokens(email) {
            try {
                // Try debug endpoint first
                const debugResult = await makeRequest(`${API_BASE}/debug/user/${email}`, 'GET');
                if (debugResult.success) {
                    console.log('Debug info for', email, ':', debugResult.data);
                    return debugResult.data;
                }
            } catch (error) {
                console.log('Debug endpoint failed, trying getAllUsers...');
            }

            // Fallback to getAllUsers
            try {
                const result = await makeRequest(`${API_BASE}/users`, 'GET');
                if (result.success) {
                    // Check in general users
                    let user = result.data.users?.find(u => u.email === email);
                    if (!user) {
                        // Check in students
                        user = result.data.students?.find(s => s.email === email);
                    }
                    
                    if (user) {
                        console.log('User found:', user);
                        return user;
                    } else {
                        console.log('User not found in either storage');
                        alert('User not found. Please register first.');
                        return null;
                    }
                }
            } catch (error) {
                console.error('Failed to get debug info:', error);
                alert('Failed to get user debug info: ' + error.message);
                return null;
            }
        }

        // Modified getVerificationToken to use enhanced debug
        async function getVerificationToken(email) {
            const userInfo = await debugUserTokens(email);
            
            if (userInfo && userInfo.emailVerificationToken) {
                document.getElementById('verifyToken').value = userInfo.emailVerificationToken;
                
                // Show token info
                const expiryInfo = userInfo.emailVerificationExpiry ? 
                    ` (Expires: ${new Date(userInfo.emailVerificationExpiry).toLocaleString()})` : '';
                    
                alert(`‚úÖ Found verification token for ${email}!${expiryInfo}\nToken has been filled in the verification field.\n\nUser Type: ${userInfo.userType || 'USER'}\nEmail Verified: ${userInfo.emailVerified ? 'Yes' : 'No'}`);
                
                return userInfo.emailVerificationToken;
            } else {
                alert(`‚ùå No verification token found for ${email}. \n\nPossible reasons:\n1. User not registered\n2. Email already verified\n3. Token expired\n\nPlease register first or use "Resend Token" if registered.`);
                return null;
            }
        }
    </script>
</body>
</html>